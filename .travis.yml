sudo: required
services:
- docker
language: python
python:
- '3.5'
stages:
- name: test
- name: build and push docker image
jobs:
  include:
  - stage: test
    script:
    - bandit -r app.py -s B104
    - echo "Finished Testing"
  - stage: build and push docker image
    install: skip
    script:
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    - export REPO="aravin008/flaskapp"
    - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo
      $TRAVIS_BRANCH ; fi`
    - docker build -f Dockerfile -t $REPO:$TAG .
    - docker image ls
    - echo "REPO:$REPO"
    - docker push $REPO
  - stage: deploy2
    env:
    - secure: kITsEDsDYl4rORrW2KaVbLbSDhksANH1Y6YwKyWHuu1KZHdYDBdgot5Ragnet10Ht1i8v1/rNhNW5yVPKIRlZ6PGgtsvHv76CuSY3A3nDuzJAas2wElG6eTx4eHm6WCd/DWiUBoho8kyYXy95LjAoOY2sDHRLIaLCdwr92taLy2Sv3QjJsDLXgrk5cJy/ZPjLFlhWSVRWiU4VYGLxG1EXa72S6SdAJRikGyM6oUNMzKU9yunEes9+OsErz/C/cEoNXRieE75GtLKs3R5EitJ9EnABw2KFqPe+ZiIsWgAeOZIDhcMOWaj38ogT3vdN4OQ3b+cI/V5fIM+DnpGbHiWkNw/LsfT2zWUO8VAjCbPqoNQ+YRGVzNOiHhFDmQRBJk4xbslUfWmmZwk6UNqYdcglUi8wAn9e/TLeIBdVaI0fGa3jblKBFrXtWBvIi5NENX4rtrlXTrPDoRX+dt8MeAb/cDiOvvPhUGj7tIYNnfR7SnvWCYekeivQmhOFpyL1lUKNK81Wap08O6CBrLe3Rj8Rlpn/pDrGNsmtwR9WmL7dV8Yvis31rgrSIUSwWtQHl/tjPU/odwKDEzm5DpOY0tOWG4SaYQJpQOBQJuH2gFAJoKqrgbFv0LemIAMkNdrW63pUQunTBZkvqRXnldqnkYhgCi4txx3pbKiUXklxDGk5xE=
    - secure: LDvr2kSuDRbETNYfgFqo/Q5qnoNJ/rgvcol+EFzPyUJnbRbzb/fcX7EZOclTyzvuKmpCuZvQjHOJh88YxRjPy2+t2cyKbKLw84be1U16wlM9T6kjbqXipS9DtVm2EgDt4vJ1WwXtI5jM+IKDpeCQzhUkRGb95DlXmoOanIFQRnWuXPCzs0GfUojB6elLhNPLl6Qa1RylgAw06SFli+aToeuuVrRv2GuOFOAhCS0h12YTrYXBYn57AndpNY7iCkFsGaOckSHQkeGwL5WAJmuUuGGHiakQNFNJJN0pbD6ybZZJKktIoe41n+iw5kKPm3C4z9o4ljxj14z8n84y7n6IwhkzZaA6zfhu26TfcMRC7SFdxt7uBEqM4W0gVVUuuvHqWxUi4lU8BVWOkQZEV/nhB12Dx46/Zvbnx/vH52QXpV0KEFZnwNWFhdm0iAifvjqJXSEG8XhpDYpBgBJKC3P3wCXZE/JiaK9Fa9LR57pnlTdbWwFLf9684a5KvLfnlec1aQMXG/WcWHtoEP1vpJNAGtrQCE1QaDIYOw0GM5cgOtY7nMqg3ehzQrjlWIWTfhZFEdzTlcbzrLxUbJgbwLBIlHDCGrwLYd8iXwif/ABCR8hkGfXR9B4hLpxflMOOAmqJ1cV7rGhE+b8GNgfLmA+geSpNV3U7ooygLgjRSSkZvu8=
    before_install:
    - openssl aes-256-cbc -K $encrypted_937fc597ef3a_key -iv $encrypted_937fc597ef3a_iv  -in secrets.tar.enc -out secrets.tar -d
    - tar xvf secrets.tar
    install: skip
    script:
    - chmod 400 "login_mar12.pem"
    - ls -al login_mar12.pem
    - scp -o "StrictHostKeyChecking no" -r -i "login_mar12.pem" mysql-img/my-sqlscript/createtable.sql
      $MACHINE:/home/ubuntu/
    - scp -o "StrictHostKeyChecking no" -r -i "login_mar12.pem" mysql-img/my-sqlscript/storedProcedure.sql
      $MACHINE:/home/ubuntu/
    - ssh  -o "StrictHostKeyChecking no" -i "login_mar12.pem" $MACHINE 'bash -s' <
      deploy.sh
