sudo: required
services:
- docker
language: python
python:
- '3.5'
stages:
- name: test
- name: build and push docker image
jobs:
  include:
  - stage: test
    script:
    - bandit -r app.py -s B104
    - echo "Finished Testing"
  - stage: build and push docker image
    install: skip
    script:
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    - export REPO="aravin008/flaskapp"
    - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo
      $TRAVIS_BRANCH ; fi`
    - docker build -f Dockerfile -t $REPO:$TAG .
    - docker image ls
    - echo "REPO:$REPO"
    - docker push $REPO
  - stage: deploy2
    env:
    - secure: sqig90gUoAPkblfzsBNqxDUc7BUwxWyMI5OlQNaNPoHODuMiOpCMwq57xBW4FgW6lEevXn95GKjBNJhKtAi8I4SGvI+KaS6n6gvXpqAbNxO1o/ISu/dEeNE4atkqQjO7tuHUIBAJ4WSg+2/v8oKYyh1HQS2HaiKtykBepnSWtsxIiscoGEt72UXIKAeyGPkgOlaS5tawt0CEsDEYfoOa8xKShdItqe32xslfhwJCTTm/zJyJEgnS/dQ+CB2JL3UGIlA8Hl1zX4rlddHGsooieDysmEQv7PNbMWyckspdNJ54drNWIBQUTbCKtHcaoseJv0fdTxnsCxAskygy5uNV5aX1E3YOlvpIIx5CcXcx1YMCpPgNi/hmcIdDNkBjgR8ou/ve1OY5+XkmpyPphN8QXk0lPGaCx75SXUfZZfnpfbgun9OnfrW+5eXgZh08tknKyVtYFXi11Z2I3ud1OMbnEZH9+tIB1SRFws8fTODHfVoW72Tj+qDDH3MuWAh0HwW+r/7AydI+JJRcPRtM9ZK+fbQQi7/GNqWWZAtwc7pVxCXtQw6+HKdYPdLFBS2icpSzEvAkBrTiCrDUbbzN7qRNqylDG8nbJvR78bnUy+PQu42upAlR3leXRCdZIct7lNW+rAcvtp5eCZNoyxqk8rCkv6yctke2HV57ctYzzDf6sbI=
    - secure: q18NsFwpQbbHFBN/KoK9jvGnF8dgLA8ikrc9P5p8QIGpBJS2QG1E7fkOZqBHts4/bBg0kz5zfWzXH/j6S2M1Y2ZeBnts93NUmH+WMkJSQdhdHiMoxXMe07e2v3ohh50Xmfnl8sMaww7kZBNyEZIXHuw0U/vcQYAsrfsKIDrLH04mC+fVCyc353s9YsjSd6p98lyGPfP9+/JFmDajpYMtlYC0dYA+fNnYOmKOdJfnJEhT+jXtZSOY5rivSRubBKlwxeQVGl/O5D6s8ETUBIMjlGebjZxDbJshAUmSKsUFmZ74CTJq3qbF2cXWOL33K1ZG2rBbQjtj5DqdFL7Heg/KRVSNPx7Iv7KoyOg9zoe1Boh8ddtZPZkiTCIOTHEQKt/qgz9kED8fHGd9Vxk6nN9WhxOwBTpHe4UVRUEz0fDCOQgC4iQqlV8Ep+Cu3Nwa/CpdZEgQVHITAZcYUdUPeFogSiWL8HXhGMh5WSIZ9MP+FrMWQP01CVVxhQUEBcV29wgMoPY4Fm9oYQi0LFI/tGGfV3tr7H8NNViBwzB2B64TAGwMV2+mq3Tn/aYdFBWd6tkP2LgGslY8R7jN4giRFmwsazb/CPNISQABdyLSaEpMBlo7z4MjdQ5SYDtLkqoQcUjOhQpI44C+eH6o/eKdw4dSp9jfTC2iadknXDf0U/TOAfM=
    before_install:
    - openssl aes-256-cbc -K $encrypted_937fc597ef3a_key -iv $encrypted_937fc597ef3a_iv -in secrets.tar.enc -out secrets.tar -d
    - tar xvf secrets.tar
    install: skip
    script:
    - chmod 400 "login_mar12.pem"
    - ls -al login_mar12.pem
    - scp -o "StrictHostKeyChecking no" -r -i "login_mar12.pem" mysql-img/my-sqlscript/createtable.sql
      $MACHINE:/home/ubuntu/
    - scp -o "StrictHostKeyChecking no" -r -i "login_mar12.pem" mysql-img/my-sqlscript/storedProcedure.sql
      $MACHINE:/home/ubuntu/
    - ssh  -o "StrictHostKeyChecking no" -i "login_mar12.pem" $MACHINE 'bash -s' <
      deploy.sh
before_install:
